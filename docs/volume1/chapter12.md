# 第12話 二人で解くバグ

　あの夜から数日後の週末。僕の部屋には、以前と同じように美久がいた。でも、部屋を流れる空気は、以前とは全く違っていた。張り詰めたような緊張感はなく、かといって馴れ合いでもない。少しだけぎこちなくて、でも、確かな信頼に満ちた、穏やかな空気がそこにはあった。

「さて、と。じゃあ、問題のヤツと向き合おうか」

　僕はノートパソコンを起動し、例のバグが起きるコードを画面に表示させた。`x`の値を上書きできない、という、僕たちを一度は引き裂いた、あの問題だ。

　以前の僕なら、すぐにコードの解説を始めていただろう。でも、今の僕は違う。

「美久。このコードを見て、どう思う？　コンピュータは、これをどういう順番で解釈しようとしてると思う？」

　僕がそう問いかけると、美久は少し驚いたような顔をしたが、すぐに真剣な表情になり、自分のノートを開いた。彼女が、自分の言葉で、自分の頭で、問題を理解しようとしてくれているのが伝わってくる。

「えっと……まず、`evaluate`関数が、`define`っていうお願いを見つけます。それで、`x`っていう名前と、`20`っていう値を、`env`、つまり『世界』に記録しようとします……よね？」
「うん、いいぞ。その通りだ」

　僕は、力強く頷いた。

「でも、僕たちの`define`は、その時、どこに記録しにいってたんだっけ？」

　僕のヒントに、美久は`Environment`クラスのコードをじっと見つめる。そして、数秒後、はっとしたように顔を上げた。

「あ……！　いつでも、一番最初の`variables`に、直接書き込んじゃってました……！」
「そうなんだ。だから、本当は、もっと身近な範囲だけで通用する名前をつけられるように、世界の仕組みを少しだけ変えてやる必要がある。この、変数が通用する範囲のことを、**スコープ**って言うんだ」

　僕は、`Environment`クラスに、「親」の世界を記録するための`parent`というプロパティを追加することを提案した。入れ子になった、階層構造を持つ世界だ。

「そして、変数を探す`lookup`のルールを、こう変えるんだ。『まず、自分の世界で探す。もし見つからなかったら、今度は親の世界に聞きに行く』。この伝言ゲームみたいな仕組みを、コードにしてみよう」

　僕が方針を説明し、今度は美久が、その説明に沿ってキーボードを叩いていく。分からないところは、「先輩、ここは`else if`でいいんですか？」と、すぐに質問してくれる。僕も、「ああ、その方が分かりやすいな」と答える。完璧な、対話によるプログラミングだった。

　そして、二人で修正した`lookup`メソッドが完成する。

```javascript
  lookup(name) {
    if (this.variables.hasOwnProperty(name)) {
      return this.variables[name];
    } else if (this.parent) {
      return this.parent.lookup(name);
    } else {
      throw new Error(`Undefined variable: ${name}`);
    }
  }
```

「よし。これで、もう一度テストしてみよう」

　緊張の一瞬。僕たちは、固唾を飲んで実行結果を見守る。画面に表示されたのは、僕たちがずっと待ち望んでいた数字だった。

`20`

「……やった！」
「やった……！」

　僕たちは、ほとんど同時に声を上げていた。思わず顔を見合わせ、笑い合う。その瞬間、僕たちの肩が、こつんと、自然に触れ合った。ほんの些細な接触。でも、僕も、そして多分美久も、心臓が少しだけ、大きく跳ねたのを感じていた。

「……私にも、できた」

　画面を見つめながら、美久がぽつりと呟いた。その声は、確かな自信と、弾むような喜びに満ちていた。

　僕は、そんな彼女の横顔を、心からの笑顔で見つめていた。

「ああ。俺たちで、やったんだ」

　僕たちの言語から、バグは消えた。そして、僕たちの間にあった、あの見えない壁も、もうどこにもなかった。