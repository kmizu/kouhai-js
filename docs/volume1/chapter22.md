# 第22話 関数という名の「実行」

「関数を定義するだけじゃ、まだ何も起こらない。次に必要なのは、その関数を『呼び出す』ことだ」

　僕は、エディタに`add`関数を呼び出す例を打ち込んだ。

`['add', 1, 2]`

「これは、『`add`という名前の関数に、`1`と`2`という値を与えて、実行してくれ』っていうお願いだ。見た目は、足し算の`['+', 1, 2]`と似てるだろ？」
「はい！　でも、どうやって区別するんですか？」

　美久の質問に、僕は頷いた。

「いい質問だ。僕たちの`evaluate`関数は、リストの最初の要素が、演算子なのか、それとも関数名なのかを判断する必要がある。もし、それが関数名だったら、その関数オブジェクトを取り出して、実行してやるんだ」

　僕は`evaluate`関数に、新しい処理を追加した。

```javascript
    // リストの場合の処理（既存の四則演算やif、begin、defineの前に）
    if (Array.isArray(exp)) {
      const head = exp[0]; // リストの最初の要素
      const args = exp.slice(1); // 残りの要素は引数

      // 最初の要素が文字列（関数名）の場合
      if (typeof head === 'string') {
        const func = env.lookup(head); // 環境から関数オブジェクトを探す

        // もし見つかったのが関数オブジェクトだったら
        if (func && func.type === 'function') {
          // ここで関数を実行する
          // 1. 新しい環境（世界）を作る
          const funcEnv = new Environment(func.env); // 関数の生まれた世界を親にする！

          // 2. 引数を新しい環境に定義する
          for (let i = 0; i < func.params.length; i++) {
            funcEnv.define(func.params[i], evaluate(args[i], env)); // 引数の値を評価して定義
          }

          // 3. 関数の本体を新しい環境で評価する
          return evaluate(func.body, funcEnv);
        }
      }
      // ...既存の四則演算、if、begin、defineの処理が続く
    }
```

「リストの最初の要素を`head`、残りを`args`として取り出す。そして、`head`が文字列だったら、それは関数名かもしれないから、まず『世界』の中からその名前を探しに行く」
「もし、見つかったのが、前に作った『関数オブジェクト』だったら……」

　僕は、ここが一番の肝だと強調した。

「関数を呼び出す時、まず、その関数が生まれた時の『世界（環境）』を親とする、新しい『子どもの世界』を作るんだ。そして、その新しい世界の中で、関数に与えられた引数（`args`）を、関数の引数名（`params`）に対応させて定義してやる」
「なるほど……！　関数が生まれた時の世界を、ちゃんと覚えてるんですね！」

　美久が、はっとしたように声を上げた。彼女の瞳が、理解の光で輝いている。

「その通りだ。そして、最後に、関数の本体（`body`）を、この新しい世界の中で実行する。これが、関数が『実行される』ということだ」

　僕は、`add`関数を定義し、呼び出すテストコードを実行した。

```javascript
const env = new Environment();
evaluate(['define', 'add', ['lambda', ['x', 'y'], ['+', 'x', 'y']]], env);
console.log(evaluate(['add', 10, 20], env)); // -> 30
```

　画面に、期待通りの`30`という数字が表示された。

「やった……！　動いた……！」

　美久が、小さく歓声を上げた。その顔は、達成感と喜びに満ちている。

「これで、僕たちの言語は、自分自身で新しい『お願い』を作り、それを実行できるようになった。これは、プログラミング言語にとって、本当に大きな一歩なんだ」

　僕の言葉に、美久は力強く頷いた。

「先輩！　これって、相沢さんをぎゃふんと言わせる、第一歩ですよね！」

　その言葉を聞いて、僕は思わず笑ってしまった。彼女のモチベーションが、相沢への対抗心だとしても、こうして一緒に、僕たちの「宝物」を磨き上げていけることが、何よりも嬉しかった。

　僕たちの言語は、また一つ、賢くなった。そして、僕たちの関係もまた、一歩、深く、確かなものへと進んだような気がした。