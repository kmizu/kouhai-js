# 第4話 計算機を作ろう

　四月二十三日、火曜日。放課後。

　情報処理室に入ると、美久がすでに席についていた。ノートを広げて、昨日のコードを写している。

「早いね」

「あ、隆弘先輩」

　美久が顔を上げる。その表情が、いつもより真剣だ。

「昨日のコード、全部書き写してみたんです」

　ノートを覗き込むと、evaluateや interpretの関数が丁寧に書かれている。しかも、自分なりのコメントまで追加されていた。

「すごい。理解度高いね」

「えへへ。でも、まだ分からないところもあって」

　美久が困った顔でコードの一部を指差す。

「このthrowってどういう意味？」

「エラーを投げるって意味。野球のピッチャーみたいに」

「なるほど！　エラーを投げて、catchで受け止めるんだ」

　美久の理解の速さに、また驚かされる。

◇◇◇◇

「今日は、昨日の続きで計算機を作っていこう」

　僕は新しいファイルを開いて、コードを書き始めた。

「計算機って、電卓みたいなもの？」

「そう。でも、ただの電卓じゃなくて、ASTを使った計算機」

　美久が首を傾げる。

「普通の電卓と何が違うの？」

「いい質問だね」

　僕はホワイトボードに図を描きながら説明した。

「普通の電卓は、入力された順番に計算する。でも、僕たちの計算機は、まず式全体を木構造にしてから計算するんだ」

「あ、だから優先順位とかも扱えるのか」

「その通り」

　美久の気づきに、つい嬉しくなってしまう。

◇◇◇◇

「じゃあ、まずは足し算から実装しよう」

```javascript
// 二項演算のAST
const additionNode = {
  type: 'BinaryExpression',
  operator: '+',
  left: {
    type: 'NumberLiteral',
    value: 10
  },
  right: {
    type: 'NumberLiteral',
    value: 20
  }
};
```

「BinaryExpressionって？」

「二項演算って意味。左と右、二つの値を使う演算のこと」

「なるほど。10 + 20 の 10が left で、20が right なんだ」

　美久がメモを取りながら頷く。

「じゃあ、このASTを評価する関数を拡張しよう」

```javascript
function evaluate(node) {
  if (node.type === 'NumberLiteral') {
    return node.value;
  }
  
  if (node.type === 'StringLiteral') {
    return node.value;
  }
  
  if (node.type === 'BinaryExpression') {
    const left = evaluate(node.left);
    const right = evaluate(node.right);
    
    switch (node.operator) {
      case '+':
        return left + right;
      case '-':
        return left - right;
      case '*':
        return left * right;
      case '/':
        return left / right;
      default:
        throw new Error(`Unknown operator: ${node.operator}`);
    }
  }
  
  throw new Error(`Unknown node type: ${node.type}`);
}
```

「わあ、一気に四則演算全部！」

「基本的な構造は同じだからね」

　実際に実行してみる。

```javascript
console.log(evaluate(additionNode)); // 30
```

「動いた！」

　美久が喜ぶ。その笑顔を見ていると、こちらまで楽しくなってくる。

◇◇◇◇

「ねえ、隆弘先輩」

　コードを打ちながら、美久が話しかけてきた。

「なんで左をleft、右をrightって呼ぶの？」

「数式を書く時の位置関係からだよ」

　僕は紙に「10 + 20」と書いて見せた。

「ほら、10は演算子の左側、20は右側にあるでしょ？」

「あ、本当だ。単純」

　美久が笑う。

「でも、単純な方が分かりやすいよね」

「プログラミングの世界では、分かりやすさが正義だから」

　そう言いながら、僕は次のコードを書き始めた。

「今度は、もう少し複雑な計算をしてみよう」

```javascript
// 1 + 2 * 3 のAST
const complexNode = {
  type: 'BinaryExpression',
  operator: '+',
  left: {
    type: 'NumberLiteral',
    value: 1
  },
  right: {
    type: 'BinaryExpression',
    operator: '*',
    left: {
      type: 'NumberLiteral',
      value: 2
    },
    right: {
      type: 'NumberLiteral',
      value: 3
    }
  }
};
```

「うわ、入れ子になってる」

「そう。これが木構造の威力」

　美久が真剣な顔で構造を追っている。

「えっと、まず2×3を計算して、その結果と1を足すのか」

「正解。実行してみよう」

```javascript
console.log(evaluate(complexNode)); // 7
```

「すごい！　ちゃんと優先順位が守られてる」

◇◇◇◇

　しばらく作業を続けていると、美久がふと手を止めた。

「隆弘先輩、質問があるんだけど」

「どうした？」

「0で割ったらどうなるの？」

　鋭い質問だ。エラー処理のことを考えているとは。

「試してみようか」

```javascript
const divisionByZeroNode = {
  type: 'BinaryExpression',
  operator: '/',
  left: {
    type: 'NumberLiteral',
    value: 10
  },
  right: {
    type: 'NumberLiteral',
    value: 0
  }
};

console.log(evaluate(divisionByZeroNode)); // Infinity
```

「Infinity？　無限大？」

「JavaScriptでは、0で割るとInfinityになるんだ」

　美久が眉をひそめる。

「でも、数学的にはおかしいよね」

「そうだね。だから、ちゃんとエラー処理を入れた方がいい」

　僕はコードを修正した。

```javascript
case '/':
  if (right === 0) {
    throw new Error('Division by zero');
  }
  return left / right;
```

「これで、0で割ろうとするとエラーになる」

「なるほど。ユーザーに優しい設計」

　また「優しい」という表現を使う美久。技術的な機能を、そういう視点で見るのが面白い。

◇◇◇◇

「休憩しようか」

　一時間ほどコードを書いて、僕は伸びをした。

「うん」

　美久も椅子から立ち上がる。

「自販機で何か買ってくる？」

「あ、私も行く」

　二人で廊下に出る。放課後の校舎は静かだ。

「隆弘先輩」

　自販機の前で、美久が小さな声で言った。

「ん？」

「プログラミング、楽しい」

　素直な感想に、僕も嬉しくなる。

「そう言ってもらえると、教えがいがある」

「でも……」

　美久がコインを入れながら、言葉を続ける。

「楽しいのは、プログラミングだけじゃないかも」

　そう言って、缶ジュースのボタンを押す。ガコンという音が、妙に大きく響いた。

（どういう意味だろう）

　考える間もなく、美久は缶を取り出して振り返った。

「先輩は何飲む？」

「あ、コーヒーで」

　いつもの調子に戻った美久。さっきの言葉の真意は、分からないままだ。

◇◇◇◇

　部屋に戻って、作業を再開する。

「次は、もっと実用的な機能を追加しよう」

「実用的？」

「括弧だよ。(1 + 2) * 3 みたいな」

　美久の目が輝く。

「あ、それができたら本物の計算機っぽい！」

「じゃあ、やってみよう」

```javascript
// (1 + 2) * 3 のAST
const parenthesesNode = {
  type: 'BinaryExpression',
  operator: '*',
  left: {
    type: 'BinaryExpression',
    operator: '+',
    left: {
      type: 'NumberLiteral',
      value: 1
    },
    right: {
      type: 'NumberLiteral',
      value: 2
    }
  },
  right: {
    type: 'NumberLiteral',
    value: 3
  }
};

console.log(evaluate(parenthesesNode)); // 9
```

「わあ、本当に括弧の中が先に計算されてる」

「ASTの構造を変えるだけで、優先順位を制御できるんだ」

　美久が感心したように頷く。

「プログラミング言語って、思ってたより柔軟なんだね」

◇◇◇◇

　夕方六時。窓の外はオレンジ色に染まっている。

「今日はここまでにしようか」

「もう？」

　美久が残念そうな顔をする。

「まだやりたいことがあったのに」

「やりたいこと？」

「うん。変数とか」

　驚いた。変数の概念を自分から言い出すなんて。

「変数は明日やろう。楽しみは取っておかないと」

「むー」

　美久が頬を膨らませる。その仕草が可愛くて、つい笑ってしまう。

「なに笑ってるの」

「いや、熱心だなって」

「当たり前でしょ。せっかく隆弘先輩が教えてくれてるんだから」

　真っ直ぐな言葉に、胸が温かくなる。

◇◇◇◇

　片付けをしながら、美久がぽつりと言った。

「ねえ、隆弘先輩」

「ん？」

「私たちが作ってる言語、いつか誰かの役に立つかな」

　予想外の質問に、少し考える。

「きっと役に立つよ」

「本当？」

「うん。少なくとも、美久の役には立ってるでしょ？」

　美久が少し照れたように笑う。

「それもそうだね」

　鞄を背負って、二人で教室を出る。

「明日は変数の実装だね」

「楽しみ」

　廊下を歩きながら、美久が言った。

「変数って、名前をつけて値を保存するんでしょ？」

「よく知ってるね」

「昨日の夜、ちょっと調べたの」

　その向学心に、また感心する。

「でも、実際に作るのとは違うから」

「分かってる。だから楽しみなの」

　昇降口で靴を履き替える。

「じゃあ、また明日」

「うん、また明日」

　美久が手を振って歩いていく。その後ろ姿を見送りながら、僕は考えていた。

　計算機が動いた。簡単な四則演算だけど、れっきとしたプログラミング言語の機能だ。

　美久の成長速度は、予想以上に速い。このペースなら、本当に言語が完成するかもしれない。

　そして、美久との距離も——

（いや、考えすぎか）

　でも、さっきの「プログラミングだけじゃない」という言葉が、頭から離れない。

　明日は変数の実装。また一歩、MikuLangが成長する。

　美久との時間も、また一日増える。

　それが嬉しいと思う自分に、少し戸惑いながら、僕も帰路についた。